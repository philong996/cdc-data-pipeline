environment: dev

kafka:
  bootstrap_servers: "10.0.0.2:9092"
  security_protocol: "PLAINTEXT"
  topics:
    - "cdc-pipeline.instacart.products"
    - "cdc-pipeline.instacart.aisles"
    - "cdc-pipeline.instacart.departments"
    - "cdc-pipeline.instacart.orders"
    - "cdc-pipeline.instacart.order_products"
  group_id: "cdc-streaming-prod"
  auto_offset_reset: "earliest"
  enable_auto_commit: false
  max_poll_records: 500

spark:
  app_name: "cdc-streaming-pipeline-prod"
  master: "spark://node-2:7077"
  log_level: "INFO"
  config:
    spark.sql.extensions: "io.delta.sql.DeltaSparkSessionExtension"
    spark.sql.catalog.spark_catalog: "org.apache.spark.sql.delta.catalog.DeltaCatalog"
    spark.sql.streaming.schemaInference: "true"
    spark.sql.shuffle.partitions: "8"
    spark.hadoop.fs.gs.impl: com.google.cloud.hadoop.fs.gcs.GoogleHadoopFileSystem
    spark.hadoop.fs.AbstractFileSystem.gs.impl: com.google.cloud.hadoop.fs.gcs.GoogleHadoopFS
    spark.hadoop.google.cloud.auth.service.account.enable: true
    spark.hadoop.google.cloud.auth.service.account.json.keyfile: /home/longnguyen/credentials/key.json
    spark.driver.memory: "2g"
    spark.executor.memory: "4g"
    spark.executor.cores: "1"
    spark.jars.packages: 
      - "org.apache.spark:spark-sql-kafka-0-10_2.13:4.0.0"
      - "io.delta:delta-spark_2.13:4.0.0"
      - "com.google.cloud.bigdataoss:gcs-connector:hadoop3-2.2.11"

logging:
  level: "INFO"
  path: "logs"
  format: "%(asctime)s - %(name)s - %(levelname)s - %(message)s"

# Storage paths for Delta Lake tables
delta:
  bronze_path: "gs://cdc-pipeline-data/prod/bronze"
  silver_path: "gs://cdc-pipeline-data/prod/silver"
  gold_path: "gs://cdc-pipeline-data/prod/gold"

# Checkpoint paths for streaming jobs
checkpoints:
  bronze_path: "gs://cdc-pipeline-data/prod/bronze/checkpoints"
  silver_path: "gs://cdc-pipeline-data/prod/silver/checkpoints"
  gold_path: "gs://cdc-pipeline-data/prod/gold/checkpoints"


# layer configurations
bronze:
  trigger_interval: "10 seconds"

silver:
  trigger_interval: "10 seconds"
  watermark_delay: "1 hour"

gold:
  trigger_interval: 900  # 15 minutes in seconds

# Table Definitions Configuration
tables:
  products:
    source_topic: "cdc-pipeline.instacart.products"
    bronze_table: "bronze.products"
    silver_table: "silver.products"
    table_type: "dimension"  # SCD Type 2
    business_keys:
      - "product_id"
    surrogate_key: "product_sk"
    attribute_columns:
      - "product_name"
      - "aisle_id"
      - "department_id"

  aisles:
    source_topic: "cdc-pipeline.instacart.aisles"
    bronze_table: "bronze.aisles"
    table_type: "dimension"  # SCD Type 2
    business_keys:
      - "aisle_id"
    surrogate_key: "aisle_sk"
    attribute_columns:
      - "aisle"

  departments:
    source_topic: "cdc-pipeline.instacart.departments"
    bronze_table: "bronze.departments"
    table_type: "dimension"  # SCD Type 2
    business_keys:
      - "department_id"
    surrogate_key: "department_sk"
    attribute_columns:
      - "department"

  orders:
    source_topic: "cdc-pipeline.instacart.orders"
    bronze_table: "bronze.orders"
    silver_table: "silver.orders"
    table_type: "fact"  # Append-only with soft deletes
    primary_keys:
      - "order_id"
    attribute_columns:
      - "user_id"
      - "order_number"
      - "order_hour_of_day"
      - "days_since_prior_order"
      - "order_date"

  order_products:
    source_topic: "cdc-pipeline.instacart.order_products"
    bronze_table: "bronze.order_products"
    silver_table: "silver.order_products"
    table_type: "fact"  # Append-only with soft deletes
    primary_keys:
      - "order_id"
      - "product_id"
    attribute_columns:
      - "add_to_cart_order"
      - "reordered"

# Gold Table Definitions
gold_tables:
  product_performance_daily:
    description: "Daily product performance metrics with aggregated sales data"
    refresh_strategy: "complete_overwrite"
    
  customer_order_summary:
    description: "Customer behavior summary with lifetime metrics"
    refresh_strategy: "complete_overwrite"
    
  order_hourly_patterns:
    description: "Order patterns aggregated by date and hour"
    refresh_strategy: "complete_overwrite"
